<%- include('partials/header', { title: 'Vehículos - Zap' , activePage:
'vehiculos' }) %>
<section id="vehiculos-disponibles" class="p-4" aria-labelledby="titulo-vehiculos">
    <h3 id="titulo-vehiculos">Vehículos disponibles</h3>

    <form id="filtro-vehiculos" class="mb-4" action="/vehiculos/filtrar" method="POST" aria-label="Filtrar vehículos disponibles">
        <div class="row g-3 align-items-end">

            <div class="d-flex flex-column col-12 col-md-6 col-lg-4 col-xl-2">
                <label for="autonomia" class="form-label">Autonomía mínima</label>
                <input type="number" id="autonomia" name="autonomia" placeholder="Ej: 300" step="50" min="0" class="form-control rounded-0 p-2 border-1 border-dark">
            </div>

            <div class="d-flex flex-column col-12 col-md-6 col-lg-4 col-xl-2">
                <label for="plazas" class="form-label">Número de plazas</label>
                <select id="plazas" name="plazas" class="form-select rounded-0 p-2 border-1 border-dark">
                    <option value="">Todas</option>
                    <option value="2">2 plazas</option>
                    <option value="4">4 plazas</option>
                    <option value="5">5 plazas</option>
                    <option value="6">6 plazas</option>
                    <option value="8">8 plazas</option>
                </select>
            </div>

            <div class="d-flex flex-column col-12 col-md-6 col-lg-4 col-xl-2">
                <label for="color" class="form-label">Color</label>
                <input type="text" id="color" name="color" placeholder="Ej: rojo" class="form-control rounded-0 p-2 border-1 border-dark">
            </div>

            <div class="d-flex flex-column col-12 col-md-6 col-lg-4 col-xl-2">
                <label for="concesionario" class="form-label">Concesionario</label>
                <select id="concesionario" name="concesionario" class="form-select rounded-0 p-2 border-1 border-dark">
                    <option value="">Todos</option>
                    <% concesionarios.forEach(c => { %>
                    <option value="<%= c.id_concesionario %>"><%= c.nombre %></option>
                    <% }) %>
                </select>
            </div>

            <div class="d-flex flex-column col-12 col-md-6 col-lg-4 col-xl-2">
                <label for="ciudad" class="form-label">Ciudad</label>
                <input type="text" id="ciudad" name="ciudad" placeholder="Ej: Madrid" class="form-control rounded-0 p-2 border-1 border-dark">
            </div>

            <div class="col-12 col-md-6 col-lg-4 col-xl-2">
                <button class="btn btn-primary w-100 p-2" type="submit">
                    <i class="bi bi-funnel-fill"></i> Filtrar
                </button>
            </div>
        </div>
    </form>

    <div class="row g-4" id="vehicle-cards">
        <% if (sol.length === 0) { %>
        <div class="col-12">
            <div class="alert alert-warning text-center" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i> No se han encontrado vehículos con los filtros seleccionados.
            </div>
        </div>
        <% } else { %>
            <% sol.forEach(v => { %>
            <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                <article class="card h-100 border-1 vehicle-card">
                    <div class="vehicle-image-wrapper">
                        <img
                            src="img/uploads/<%=v.imagen%>"
                            alt="<%= v.marca %> <%= v.modelo %> <%= v.color %>"
                            class="card-img-top vehicle-image"
                            loading="lazy">
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h4 class="card-title mb-2"><%= v.marca %> <%= v.modelo %></h4>
                        <p class="badge bg-secondary me-auto mb-3"><%= v.matricula %></p>

                        <div class="vehicle-specs mb-3">
                            <div class="spec-item">
                                <span class="spec-label">Color</span>
                                <span class="spec-value"><%= v.color %></span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-label">Autonomía</span>
                                <span class="spec-value"><%= v.autonomia_km %> km</span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-label">Plazas</span>
                                <span class="spec-value"><%= v.numero_plazas %></span>
                            </div>
                            <div class="spec-item">
                                <span class="spec-label">Año de matriculación</span>
                                <span class="spec-value"><%= v.ano_matriculacion %></span>
                            </div>
                        </div>

                        <div class="mt-auto">
                            <p class="text-muted mb-3">
                                <i class="bi bi-geo-alt-fill"></i> <%= v.nombre_concesionario %>
                            </p>
                            <button class="btn btn-primary w-100 p-2" type="button" aria-label="Ver detalles de <%= v.marca %> <%= v.modelo %>">
                                <i class="bi bi-info-circle-fill"></i> Ver detalles
                            </button>
                        </div>
                    </div>
                </article>
            </div>
            <% }) %>
        <% } %>
    </div>
        <!--
    <table class="table table-striped border border-2 w-100 align-middle">
        <caption>
            Vehículos disponibles
        </caption>

        <thead class="fs-5 text-center">
            <tr class="bg-zapgrey">
                <th scope="col"></th>
                <th scope="col">Matrícula</th>
                <th scope="col">Marca</th>
                <th scope="col">Modelo</th>
                <th scope="col">Año matriculación</th>
                <th scope="col">Autonomía (km)</th>
                <th scope="col">Plazas</th>
                <th scope="col">Concesionario</th>
            </tr>
        </thead>
        <tbody id="vehiculos" class="fs-5 text-center">
            <% sol.forEach(v=> { %>
            <tr>
                <td>
                    <img
                        src="img/uploads/<%=v.imagen %>"
                        alt="<%= v.marca %> <%= v.modelo %> <%= v.color %>"
                        style="width: 150px; height: auto"
                    />
                </td>
                <td><%= v.matricula %></td>
                <td><%= v.marca %></td>
                <td><%= v.modelo %></td>
                <td><%= v.ano_matriculacion %></td>
                <td><%= v.autonomia_km %> km</td>
                <td><%= v.numero_plazas %></td>
                <td><%= v.nombre_concesionario %></td>
            </tr>
            <% }) %>
        </tbody>
    </table>
    -->
</section>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('filtro-vehiculos');
        const vehicleCardsContainer = document.getElementById('vehicle-cards');

        form.addEventListener('submit', function (e) {
            e.preventDefault();

            const autonomia = document.getElementById('autonomia').value;
            const plazas = document.getElementById('plazas').value;
            const color = document.getElementById('color').value;
            const concesionario = document.getElementById('concesionario').value;
            const ciudad = document.getElementById('ciudad').value;

            const params = new URLSearchParams();
            if (autonomia) params.append('autonomia', autonomia);
            if (plazas) params.append('plazas', plazas);
            if (color) params.append('color', color);
            if (concesionario) params.append('concesionario', concesionario);
            if (ciudad) params.append('ciudad', ciudad);

            fetch(`/vehiculos/filtrar?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la petición');
                }
                return response.json();
            })
            .then(vehiculos => {
                let html = '';

                if (vehiculos.length === 0) {
                    html = `
                        <div class="col-12">
                            <div class="alert alert-warning text-center" role="alert">
                                <i class="bi bi-exclamation-triangle-fill"></i> No se han encontrado vehículos con los filtros seleccionados.
                            </div>
                        </div>
                    `;
                } else {
                    vehiculos.forEach(v => {
                        html += `
                            <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
                                <article class="card h-100 border-1 vehicle-card">
                                    <div class="vehicle-image-wrapper">
                                        <img
                                            src="img/uploads/${v.imagen}"
                                            alt="${v.marca} ${v.modelo} ${v.color}"
                                            class="card-img-top vehicle-image"
                                            loading="lazy">
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <h4 class="card-title mb-2">${v.marca} ${v.modelo}</h4>
                                        <p class="vehicle-plate mb-3">${v.matricula}</p>

                                        <div class="vehicle-specs mb-3">
                                            <div class="spec-item">
                                                <span class="spec-label">Color</span>
                                                <span class="spec-value">${v.color}</span>
                                            </div>
                                            <div class="spec-item">
                                                <span class="spec-label">Autonomía</span>
                                                <span class="spec-value">${v.autonomia_km} km</span>
                                            </div>
                                            <div class="spec-item">
                                                <span class="spec-label">Plazas</span>
                                                <span class="spec-value">${v.numero_plazas}</span>
                                            </div>
                                            <div class="spec-item">
                                                <span class="spec-label">Año de matriculación</span>
                                                <span class="spec-value">${v.ano_matriculacion}</span>
                                            </div>
                                        </div>

                                        <div class="mt-auto">
                                            <p class="text-muted mb-3">
                                                <i class="bi bi-geo-alt-fill"></i> ${v.nombre_concesionario}
                                            </p>
                                            <button class="btn btn-primary w-100 p-2" type="button" aria-label="Ver detalles de ${v.marca} ${v.modelo}">
                                                <i class="bi bi-info-circle-fill"></i> Ver detalles
                                            </button>
                                        </div>
                                    </div>
                                </article>
                            </div>
                        `;
                    });
                }

                vehicleCardsContainer.innerHTML = html;
            })
            .catch(function (error) {
                console.error('Error:', error);
                vehicleCardsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger text-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill"></i> Ha ocurrido un error al filtrar los vehículos. Por favor, inténtalo de nuevo.
                        </div>
                    </div>
                `;
            });
        });
    });
</script>


<%- include('partials/footer') %>
