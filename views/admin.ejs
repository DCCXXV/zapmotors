<%- include('partials/header', { title: 'Admin - Zap', activePage: 'none' }) %>

<section id="contacto">
    <h3 class="m-4">Panel de Administración</h3>
    <a class="ms-4 btn btn-primary" href="/setup"> Cargar JSON</a>
    <div class="d-flex flex-column flex-lg-row gap-4 m-4">
        <div class="d-flex flex-column col-12 col-lg-6">
            <h4>Registro de empleado</h4>
            <div class="w-100 border p-2">
                <form
                    id="altaUsuarios"
                    class="d-flex flex-column">
                    <div class="d-flex flex-column gap-2 mb-3">
                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="name">Nombre: </label>
                                <input
                                    id="name"
                                    name="name"
                                    type="text"
                                    placeholder="John Doe"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="email">Correo electrónico: </label>
                                <input
                                    id="email"
                                    name="email"
                                    type="email"
                                    pattern="^[A-Za-z0-9._%+-]+@zapmotors\.com$"
                                    title="Debe ser un correo corporativo (@zapmotors.com)"
                                    placeholder="johndoe@zapmotors.com"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>

                        <div class="d-flex flex-column">
                            <label for="password">Contraseña: </label>
                            <input
                                id="passwordInput"
                                name="password"
                                type="password"
                                minlength="8"
                                pattern="(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*]).{8,}"
                                title="Mínimo 8 caracteres, al menos 1 mayúscula, 1 número y 1 carácter especial."
                                placeholder="Introduce tu contraseña"
                                class="border p-2"
                                required />
                        </div>

                        <div class="d-flex flex-column">
                            <label for="telefono">Teléfono: </label>
                            <input type="tel" name="telephone" placeholder="679 56 12 12" class="form-label border p-2" maxlength="9" pattern="^[0-9]{9}$" title="Introduce un teléfono de 9 dígitos (solo números)" required>
                        </div>

                        <div class="d-flex flex-column">
                            <label for="dealership">Concesionario: </label>
                            <input id="dealership" type="number" name="dealership" value="1" class="form-number border p-2" required>
                        </div>
                    </div>

                    <% if (typeof errMsg !=='undefined' && errMsg) { %>
                    <div class="alert alert-danger mb-3" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i> <%= errMsg %>
                    </div>
                    <% } %>
                    <div id="user-msg-box" class="mb-3"></div>
                    <button class="btn btn-primary rounded-0 mt-auto" type="submit">
                        <i class="bi bi-person-plus-fill me-2"></i>Registrar empleado
                    </button>
                </form>
            </div>
        </div>
        <div class="d-flex flex-column col-12 col-lg-6">
            <h4>Lista de usuarios</h4>
            <div id="user-container" class="w-100 border d-flex flex-column p-2 overflow-auto">
                <table class="table table-striped border border-2 w-100">
                    <thead>
                        <tr class="text-center">
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Correo</th>
                            <th>Rol</th>
                            <th>Eliminar</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let u of users) { %>
                        <tr class="text-center align-middle" data-user-id="<%= u.id_usuario %>">
                            <td><%= u.id_usuario %></td>
                            <td><%= u.nombre %></td>
                            <td><%= u.correo %></td>
                            <td>
                                <select name="rol" class="form-select form-select-sm update-rol-select" data-user-id="<%= u.id_usuario %>" aria-label="Cambiar rol del usuario">
                                    <option value="empleado" <%= u.rol === 'empleado' ? 'selected' : '' %> >Empleado</option>
                                    <option value="admin" <%= u.rol === 'admin' ? 'selected' : '' %> >Administrador</option>
                                </select>
                            </td>

                            <td class="text-center">
                                <button class="btn btn-danger delete-user-btn" data-user-id="<%= u.id_usuario %>">
                                    <i aria-label="Eliminar usuario" class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="d-flex flex-column flex-lg-row gap-4 m-4">
        <div class="d-flex flex-column col-12 col-lg-6">
            <h4>Registro de vehículo</h4>
            <div class="w-100 border p-2">
                <form
                    id="altaVehiculo"
                    enctype="multipart/form-data"
                    class="d-flex flex-column w-100">
                    <div class="d-flex flex-column gap-2 mb-3">
                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="licensePlate">Matrícula:</label>
                                <input
                                    id="licensePlate"
                                    name="licensePlate"
                                    type="text"
                                    placeholder="1234ABC"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="brand">Marca:</label>
                                <input
                                    id="brand"
                                    name="brand"
                                    type="text"
                                    placeholder="Tesla"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>

                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="model">Modelo:</label>
                                <input
                                    id="model"
                                    name="model"
                                    type="text"
                                    placeholder="Model 3"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="registrationYear">Año de matriculación:</label>
                                <input
                                    id="registrationYear"
                                    name="registrationYear"
                                    type="number"
                                    placeholder="2024"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>

                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="seatsNumber">Número de plazas:</label>
                                <input
                                    id="seatsNumber"
                                    name="seatsNumber"
                                    type="number"
                                    placeholder="5"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="rangeKm">Autonomía (km):</label>
                                <input
                                    id="rangeKm"
                                    name="rangeKm"
                                    type="number"
                                    placeholder="500"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>

                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="color">Color:</label>
                                <input
                                    id="color"
                                    name="color"
                                    type="text"
                                    placeholder="Blanco"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="image">Imagen:</label>
                                <input
                                    class="form-control rounded-0 border-dark p-2"
                                    id="image"
                                    type="file"
                                    name="image"
                                    accept="image/*"
                                    required />
                            </div>
                        </div>

                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="status">Estado:</label>
                                <select id="status" name="status" class="border p-2 rounded-0">
                                    <option value="disponible" selected>Disponible</option>
                                    <option value="mantenimiento">Mantenimiento</option>
                                    <option value="reservado">Reservado</option>
                                </select>
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="dealershipId">ID concesionario: </label>
                                <input
                                    id="dealershipId"
                                    name="dealershipId"
                                    type="number"
                                    placeholder="1"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>
                    </div>
                    <div id="vehicle-msg-box" class="mb-3"></div>
                    <button class="btn btn-primary rounded-0 mt-auto" type="submit">
                        <i class="bi bi-car-front-fill me-2"></i>Registrar vehículo
                    </button>
                </form>
            </div>
        </div>
        <div class="d-flex flex-column col-12 col-lg-6">
            <h4>Lista de vehículos</h4>
            <div id="vehicles-container" class="w-100 border d-flex flex-column p-2 overflow-auto">
                <table class="table table-striped border border-2 w-100" style="table-layout: fixed;">
                    <thead>
                        <tr class="text-center">
                            <th style="width: 10%;">ID</th>
                            <th style="width: 25%;">Matricula</th>
                            <th style="width: 25%;">Marca</th>
                            <th style="width: 25%;">Modelo</th>
                            <th style="width: 15%;">Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let v of vehicles) { %>
                        <tr class="text-center align-middle" data-vehicle-id="<%= v.id_vehiculo %>">
                            <td><%= v.id_vehiculo %></td>
                            <td><%= v.matricula %></td>
                            <td><%= v.marca %></td>
                            <td><%= v.modelo %></td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-secondary edit-vehicle-btn">
                                        <i aria-label="Modificar vehículo" class="bi bi-pencil-fill"></i>
                                    </button>
                                    <button class="btn btn-danger delete-vehicle-btn">
                                        <i aria-label="Eliminar vehículo" class="bi bi-trash-fill"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="d-flex flex-column flex-lg-row gap-4 m-4">
        <div class="d-flex flex-column col-12 col-lg-6">
            <h4>Registro de concesionario</h4>
            <div class="w-100 border p-2">
                <form
                    id="altaConcesionario"
                    class="d-flex flex-column w-100">
                    <div class="d-flex flex-column gap-2 mb-3">
                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="dealershipsName">Nombre:</label>
                                <input
                                    id="dealershipsName"
                                    name="dealershipsName"
                                    type="text"
                                    placeholder="Zap Motors Madrid"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="city">Ciudad:</label>
                                <input
                                    id="city"
                                    name="city"
                                    type="text"
                                    placeholder="Madrid"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>

                        <div class="d-flex flex-column flex-lg-row gap-2">
                            <div class="d-flex flex-column flex-fill">
                                <label for="address">Dirección:</label>
                                <input
                                    id="address"
                                    name="address"
                                    type="text"
                                    placeholder="Calle Gran Vía, 28"
                                    required
                                    class="border p-2" />
                            </div>
                            <div class="d-flex flex-column flex-fill">
                                <label for="phone">Teléfono:</label>
                                <input
                                    id="phone"
                                    name="phone"
                                    type="number"
                                    placeholder="912345678"
                                    required
                                    class="border p-2" />
                            </div>
                        </div>
                    </div>
                    <div id="dealership-msg-box" class="mb-3"></div>
                    <button class="btn btn-primary rounded-0 mt-auto" type="submit">
                        <i class="bi bi-building-fill-add me-2"></i>Registrar concesionario
                    </button>
                </form>
            </div>
        </div>
        <div class="d-flex flex-column col-12 col-lg-6">
            <h4>Lista de concesionario</h4>
            <div id="dealerships-container" class="w-100 border d-flex flex-column p-2 overflow-auto">
                <table class="table table-striped border border-2 w-100">
                    <thead>
                        <tr class="text-center">
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Ciudad</th>
                            <th>Direccion</th>
                            <th>Teléfono</th>
                            <th>Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% for (let c of dealerships) { %>
                        <tr class="text-center align-middle" data-dealership-id="<%= c.id_concesionario %>">
                            <td><%= c.id_concesionario %></td>
                            <td><%= c.nombre %></td>
                            <td><%= c.ciudad %></td>
                            <td><%= c.direccion %></td>
                            <td><%= c.telefono_contacto %></td>
                            <td class="text-center d-flex justify-content-center gap-2">
                                <button class="btn btn-secondary edit-dealership-btn">
                                    <i aria-label="Modificar concesionario" class="bi bi-pencil-fill"></i>
                                </button>
                                <button class="btn btn-danger delete-dealership-btn">
                                    <i aria-label="Eliminar concesionario" class="bi bi-trash-fill"></i>
                                </button>
                            </td>
                        </tr>
                        <% } %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


    <div class="modal fade" id="editVehicleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Vehículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editVehicleForm" method="POST">
                    <div class="modal-body">
                        <input type="hidden" id="edit-id" name="id">
                        <div class="mb-3">
                            <label for="edit-licensePlate" class="form-label">Matrícula:</label>
                            <input type="text" class="form-control" id="edit-licensePlate" name="licensePlate" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-brand" class="form-label">Marca:</label>
                            <input type="text" class="form-control" id="edit-brand" name="brand" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-model" class="form-label">Modelo:</label>
                            <input type="text" class="form-control" id="edit-model" name="model" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-registrationYear" class="form-label">Año de matriculación:</label>
                            <input type="number" class="form-control" id="edit-registrationYear" name="registrationYear" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-seatsNumber" class="form-label">Número de plazas:</label>
                            <input type="number" class="form-control" id="edit-seatsNumber" name="seatsNumber" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-rangeKm" class="form-label">Autonomía (km):</label>
                            <input type="number" class="form-control" id="edit-rangeKm" name="rangeKm" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-color" class="form-label">Color:</label>
                            <input type="text" class="form-control" id="edit-color" name="color" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-status" class="form-label">Estado:</label>
                            <select class="form-select" id="edit-status" name="status">
                                <option value="disponible">Disponible</option>
                                <option value="mantenimiento">Mantenimiento</option>
                                <option value="reservado">Reservado</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer d-flex flex-column align-items-stretch">
                        <div id="edit-vehicle-msg-box"></div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary p-2 border-0" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-dark p-2 border-0">Guardar cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editDealershipModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Concesionario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editDealershipForm" method="POST">
                    <div class="modal-body">
                        <input type="hidden" id="edit-dealership-id" name="id">
                        <div class="mb-3">
                            <label for="edit-dealership-name" class="form-label">Nombre:</label>
                            <input type="text" class="form-control" id="edit-dealership-name" name="dealershipsName" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-dealership-city" class="form-label">Ciudad:</label>
                            <input type="text" class="form-control" id="edit-dealership-city" name="city" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-dealership-address" class="form-label">Dirección:</label>
                            <input type="text" class="form-control" id="edit-dealership-address" name="address" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-dealership-phone" class="form-label">Teléfono:</label>
                            <input type="text" class="form-control" id="edit-dealership-phone" name="phone" required>
                        </div>
                    </div>
                    <div class="modal-footer d-flex flex-column align-items-stretch">
                        <div id="edit-dealership-msg-box"></div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary p-2 border-0" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-dark p-2 border-0">Guardar cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // funcion helper para mostrar mensajes en contexto
    function showMsgBox(containerId, message, type = 'danger') {
        const container = document.getElementById(containerId);
        if (!container) return;

        const icon = type === 'success' ? 'bi-check-circle-fill' :
                     type === 'danger' ? 'bi-exclamation-triangle-fill' :
                     type === 'warning' ? 'bi-exclamation-triangle-fill' :
                     'bi-info-circle-fill';

        container.innerHTML = `
            <div class="alert alert-${type} mb-0" role="alert">
                <i class="bi ${icon}"></i> ${message}
            </div>
        `;

        // auto limpiar después de 10 segundos
        setTimeout(() => {
            container.innerHTML = '';
        }, 10000);
    }

    document.getElementById('altaUsuarios').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const form = e.target;

        const data = {
            name: formData.get('name'),
            email: formData.get('email'),
            password: formData.get('password'),
            telephone: formData.get('telephone'),
            dealership: formData.get('dealership')
        };

        fetch('/api/usuarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.error || 'Error al crear usuario');
                });
            }
            return response.json();
        })
        .then(data => {
            form.reset();

            // Añadir fila a la tabla
            const tbody = document.querySelector('#user-container tbody');
            const newRow = document.createElement('tr');
            newRow.className = 'text-center align-middle';
            newRow.dataset.userId = data.id;
            newRow.innerHTML = `
                <td>${data.id}</td>
                <td>${data.nombre}</td>
                <td>${data.correo}</td>
                <td>
                    <select name="rol" class="form-select form-select-sm update-rol-select" data-user-id="${data.id}" arial-label="Cambiar rol del usuario">
                        <option value="empleado" ${data.rol === 'empleado' ? 'selected' : ''}>Empleado</option>
                        <option value="admin" ${data.rol === 'admin' ? 'selected' : ''}>Administrador</option>
                    </select>
                </td>
                <td class="text-center">
                    <button class="btn btn-danger delete-user-btn" data-user-id="${data.id}">
                        <i arial-label="Eliminar usuario" class="bi bi-trash-fill"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
            showMsgBox('user-msg-box', 'Usuario registrado correctamente', 'success');
        })
        .catch(error => {
            console.error(error);
            showMsgBox('user-msg-box', error.message, 'danger');
        });
    });

    document.querySelector('#user-container').addEventListener('change', (e) => {
        const select = e.target.closest('.update-rol-select');

        if (select) {
            const userId = select.dataset.userId;
            const nuevoRol = select.value;

            fetch(`/api/usuarios/${userId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({rol:nuevoRol})
            }).then(response => {
                if (!response.ok) throw new Error('Error al actualizar rol');
                return response.json();
            }).catch(error => {
                console.error(error);
                showMsgBox('user-msg-box', 'Error al actualizar rol', 'danger');
                location.reload();
            });
        }
    })

    document.querySelector('#user-container').addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-user-btn');

        if (deleteBtn) {
            if (!confirm('¿Estás seguro de que quieres eliminar este usuario?')) {
                return;
            }

            const userId = deleteBtn.dataset.userId;
            fetch(`/api/usuarios/${userId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al eliminar usuario');
                }
                return response.json();
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error(error);
                showMsgBox('user-msg-box', 'Error al eliminar usuario', 'danger');
                location.reload();
            });
        }
    })

    document.getElementById('altaVehiculo').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const form = e.target;

        fetch('/api/vehiculos', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al crear vehículo');
            }
            return response.json();
        })
        .then(data => {
            form.reset();

            // Añadir fila a la tabla
            const tbody = document.querySelector('#vehicles-container tbody');
            const newRow = document.createElement('tr');
            newRow.className = 'text-center align-middle';
            newRow.dataset.vehicleId = data.id;
            newRow.innerHTML = `
                <td>${data.id}</td>
                <td>${formData.get('licensePlate')}</td>
                <td>${formData.get('brand')}</td>
                <td>${formData.get('model')}</td>
                <td class="text-center">
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-secondary edit-vehicle-btn">
                            <i arial-label="Modificar vehículo" class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-danger delete-vehicle-btn">
                            <i arial-label="Eliminar vehículo" class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(newRow);
            showMsgBox('vehicle-msg-box', 'Vehículo registrado correctamente', 'success');
        })
        .catch(error => {
            console.error(error);
            showMsgBox('vehicle-msg-box', 'Error al crear vehículo', 'danger');
        });
    });

    document.querySelector('#vehicles-container').addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-vehicle-btn');

            if (deleteBtn) {
                if (!confirm('¿Seguro que quieres eliminar este vehículo?')) {
                    return;
                }

                const row = deleteBtn.closest('tr');
                const id = row.dataset.vehicleId;

                fetch(`/api/vehiculos/${id}`, {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok) throw new Error('Error al eliminar el vehículo');
                    return response.json();
                })
                .then(data => {
                    row.remove();
                })
                .catch(error => {
                    console.error(error);
                    showMsgBox('vehicle-msg-box', 'Error al eliminar el vehículo', 'danger');
                });
            }
        });

    document.querySelector('#vehicles-container').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-vehicle-btn');

        if (editBtn) {
            const row = editBtn.closest('tr');
            const id = row.dataset.vehicleId;

            fetch(`/api/vehiculos/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error al obtener vehículo');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('edit-id').value = data.id_vehiculo;
                    document.getElementById('edit-licensePlate').value = data.matricula;
                    document.getElementById('edit-brand').value = data.marca;
                    document.getElementById('edit-model').value = data.modelo;
                    document.getElementById('edit-registrationYear').value = data.ano_matriculacion;
                    document.getElementById('edit-seatsNumber').value = data.numero_plazas;
                    document.getElementById('edit-rangeKm').value = data.autonomia_km;
                    document.getElementById('edit-color').value = data.color;
                    document.getElementById('edit-status').value = data.estado;

                    document.getElementById('editVehicleForm').dataset.vehicleId = id;

                    const modal = new bootstrap.Modal(document.getElementById('editVehicleModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error(error);
                    showMsgBox('vehicle-msg-box', 'Error al cargar los datos del vehículo', 'danger');
                });
        }
    });

    document.getElementById('editVehicleForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const id = e.target.dataset.vehicleId;
        const formData = new FormData(e.target);

        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        fetch(`/api/vehiculos/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error('Error al actualizar vehículo');
            return response.json();
        })
        .then(data => {
            const row = document.querySelector(`tr[data-vehicle-id="${id}"]`);
            row.querySelector('td:nth-child(2)').textContent = formData.get('licensePlate');
            row.querySelector('td:nth-child(3)').textContent = formData.get('brand');
            row.querySelector('td:nth-child(4)').textContent = formData.get('model');

            const modal = bootstrap.Modal.getInstance(document.getElementById('editVehicleModal'));
            modal.hide();
            showMsgBox('vehicle-msg-box', 'Vehículo actualizado correctamente', 'success');
        })
        .catch(error => {
            console.error(error);
            showMsgBox('edit-vehicle-msg-box', 'Error al actualizar el vehículo', 'danger');
        });
    });

    document.getElementById('altaConcesionario').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const form = this;

        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        fetch('/api/concesionarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al crear Concesionario');
            }
            return response.json();
        })
        .then(data => {
            form.reset();

            // Añadir fila a la tabla
            const tbody = document.querySelector('#dealerships-container tbody');
            const newRow = document.createElement('tr');
            newRow.className = 'text-center align-middle';
            newRow.dataset.dealershipId = data.id;
            newRow.innerHTML = `
                <td>${data.id}</td>
                <td>${formData.get('dealershipsName')}</td>
                <td>${formData.get('city')}</td>
                <td>${formData.get('address')}</td>
                <td>${formData.get('phone')}</td>
                <td class="text-center d-flex justify-content-center gap-2">
                    <button class="btn btn-secondary edit-dealership-btn">
                        <i arial-label="Modificar concesionario" class="bi bi-pencil-fill"></i>
                    </button>
                    <button class="btn btn-danger delete-dealership-btn">
                        <i arial-label="Eliminar concesionario" class="bi bi-trash-fill"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(newRow);
            showMsgBox('dealership-msg-box', 'Concesionario registrado correctamente', 'success');
        })
        .catch(error => {
            console.error(error);
            showMsgBox('dealership-msg-box', 'Error al crear concesionario', 'danger');
        });
    });

    document.querySelector('#dealerships-container').addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.delete-dealership-btn');

        if (deleteBtn) {
            if (!confirm('¿Seguro que quieres eliminar este concesionario?')) {
                return;
            }

            const row = deleteBtn.closest('tr');
            const id = row.dataset.dealershipId;

            fetch(`/api/concesionarios/${id}`, {
                method: 'DELETE',
            })
            .then(response => {
                if (!response.ok) throw new Error('Error al eliminar el concesionario');
                return response.json();
            })
            .then(data => {
                row.remove();
            })
            .catch(error => {
                console.error(error);
                showMsgBox('dealership-msg-box', 'Error al eliminar el concesionario', 'danger');
            });
        }
    });

    document.querySelector('#dealerships-container').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-dealership-btn');

        if (editBtn) {
            const row = editBtn.closest('tr');
            const id = row.dataset.dealershipId;

            fetch(`/api/concesionarios/${id}`)
                .then(response => {
                    if (!response.ok) throw new Error('Error al obtener concesionario');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('edit-dealership-id').value = data.id_concesionario;
                    document.getElementById('edit-dealership-name').value = data.nombre;
                    document.getElementById('edit-dealership-city').value = data.ciudad;
                    document.getElementById('edit-dealership-address').value = data.direccion;
                    document.getElementById('edit-dealership-phone').value = data.telefono_contacto;

                    document.getElementById('editDealershipForm').dataset.dealershipId = id;

                    const modal = new bootstrap.Modal(document.getElementById('editDealershipModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error(error);
                    showMsgBox('dealership-msg-box', 'Error al cargar los datos del concesionario', 'danger');
                });
        }
    });

    document.getElementById('editDealershipForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const id = e.target.dataset.dealershipId;
        const formData = new FormData(e.target);

        const data = {};
        formData.forEach((value, key) => {
            data[key] = value;
        });

        fetch(`/api/concesionarios/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error('Error al actualizar concesionario');
            return response.json();
        })
        .then(data => {
            const row = document.querySelector(`tr[data-dealership-id="${id}"]`);
            row.querySelector('td:nth-child(2)').textContent = formData.get('dealershipsName');
            row.querySelector('td:nth-child(3)').textContent = formData.get('city');
            row.querySelector('td:nth-child(4)').textContent = formData.get('address');
            row.querySelector('td:nth-child(5)').textContent = formData.get('phone');

            const modal = bootstrap.Modal.getInstance(document.getElementById('editDealershipModal'));
            modal.hide();
            showMsgBox('dealership-msg-box', 'Concesionario actualizado correctamente', 'success');
        })
        .catch(error => {
            console.error(error);
            showMsgBox('edit-dealership-msg-box', 'Error al actualizar el concesionario', 'danger');
        });
    });
})

</script>

<!-- seccion de stats -->
<section class="m-4" aria-labelledby="titulo-estadisticas">
    <h3 id="titulo-estadisticas">Estadísticas</h3>

    <div class="d-flex flex-column flex-lg-row gap-4 mt-4">

        <!-- reservas por concesionario -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Reservas por concesionario</h4>
                </div>
                <div class="card-body">
                    <% if (statsByDealership && statsByDealership.length > 0) { %>
                        <table class="table table-striped" aria-label="Estadísticas de reservas por concesionario">
                            <thead>
                                <tr>
                                    <th scope="col">Concesionario</th>
                                    <th scope="col" class="text-end">Total Reservas</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for (let stat of statsByDealership) { %>
                                    <tr>
                                        <td><%= stat.concesionario %></td>
                                        <td class="text-end"><%= stat.total_reservas %></td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div class="alert alert-info text-center mb-0" role="alert">
                            <i class="bi bi-info-circle-fill"></i> No hay datos de reservas disponibles
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- vehículos más usados -->
        <div class="col-12 col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Top 5 vehículos más reservados</h4>
                </div>
                <div class="card-body">
                    <% if (mostUsedVehicles && mostUsedVehicles.length > 0) { %>
                        <table class="table table-striped" aria-label="Vehículos más reservados">
                            <thead>
                                <tr>
                                    <th scope="col">Matrícula</th>
                                    <th scope="col">Vehículo</th>
                                    <th scope="col" class="text-end">Reservas</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% for (let vehicle of mostUsedVehicles) { %>
                                    <tr>
                                        <td><%= vehicle.matricula %></td>
                                        <td><%= vehicle.marca %> <%= vehicle.modelo %> (<%= vehicle.color %>)</td>
                                        <td class="text-end"><%= vehicle.total_reservas %></td>
                                    </tr>
                                <% } %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <div class="alert alert-info text-center mb-0" role="alert">
                            <i class="bi bi-info-circle-fill"></i> No hay datos de vehículos disponibles
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</section>

<%- include('partials/footer') %>
